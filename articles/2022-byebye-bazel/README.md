# Bazel にさよならして make を使いはじめた話

こんにちは。MIXI 開発本部 SREグループの [riddle](https://twitter.com/riddle_tec) です。

ビルドツールとして Bazel を利用していたのですが、いろいろあって make に変えたので、**「Bazel をなぜ導入してなぜやめたのか？」** を紹介します。

## 目次

# Bazel とは

![picture 12](images/d6cf98708f23dd77e97448ff55da3f7deb581ec5ba4d5258842f9961b4851317.png)  

Bazel は Google が開発したビルドツールで、Java、C++、Go、Android、iOS、その他多くの言語とプラットフォームを使用してビルドとテストができます。

ローカルやリモートのキャッシュをうまく用い、アプリケーションのビルドやコンテナイメージの生成、テストなどさまざまな開発のライフサイクルで活躍してくれます。

またルールを用意すれば Kubernetes にデプロイしてくれたり、シェルを実行してくれたりなどその適用範囲は非常に広いです。

- [Googleが開発する最新ビルドツール「Bazel」を使ってみよう | さくらのナレッジ](https://knowledge.sakura.ad.jp/6174/)
- [Bazelの解説（TS, Dockerイメージ、リモートキャッシュ）](https://zenn.dev/kesin11/books/c86010deb5b8008f394f)

# どこに Bazel を使ってたのか？

主に以下の用途で使っていました。

- テスト実行
- Go バイナリのビルド
- コンテナイメージの Build と Push
- 自動コード生成
- モックの生成

なので開発する場合は最初にローカルで Bazel を動かしてコードを生成し、テストで使っており、CI でテスト・コンテナイメージの生成を行なっていました。

導入理由としては以下の理由が挙げられます。

- 元々モンスターストライクの開発に Bazel を利用していたこと
- 開発当時は M1 Mac が登場したタイミングだったので、Intel / Arm のアーキテクチャが混在していたこと

# なぜ Bazel をやめたのか？

![picture 13](images/676d3d95277c1dd69604cbcfde29363912e9f1b159a2be9ddd1adf12029c84d4.png)  

以下の3点の理由です

1. Bazel の運用コストが高い
2. Bazel の速度問題
3. Bazel ではできないことがある

## 1. Bazel の運用コストが高かった

Bazel はさまざまな設定ファイルをあらかじめ用意しなければなりません。

最初に Bazel を入れてくれた方が詳しかったので最初は問題なかったのですが、プロジェクトの規模が大きくなるに連れてメンバーが増えました。

しかし Bazel をキャッチアップするコストが払えず、ほとんどのメンバーが Bazel 関連のコードを書くことができずあるものを使うだけという状態になってしまいました。これは Bazel の複雑性や rule の多様化、頻繁に bazel や rule にアップデート入ることなど複数の要因があると思います。

## 2. Bazel の速度問題

![picture 14](images/e87fe950a257706ac59b1ae9ed037da9697e4bf5500a5eff101fbb9e493e94b2.png)  

ローカルで Bazel を実行するとさまざまな rule で設定されたツールをダウンロードしたり、メインの処理の前の解析フェーズに時間がかかってしまい、処理が遅いと感じることが結構な頻度でありました。

※たまにタイミングイシューで `go get` が timeout する問題もあった

また弊社特有の事象にはなりますが、Bazel によって生成された一時ファイルがウイルススキャンツールによって検査の対象となってしまい、処理に非常に時間がかかるという状況でした。

## 3. Bazel ではできないことがある

![picture 15](images/3fc98c9570bed8dfbb85906754682b18ecb6eb13a4d4f27d2a8d351e35bfbf8f.png)  

Bazel は同じ WORKSPACE で並列にジョブを実行できないため、テスト実施中は Bazel を使ったコンテナイメージを生成したりできません。CI 上で高速化のために処理を並列実行したかったのですが、上記の制約によりできないシーンがありました。

また CI で Bazel を利用する場合、Bazel のコンテナイメージを使うのですがこれが非常に重く、1GB を超えるコンテナイメージでダウンロードに時間がかかるのも厳しかったですね。

またローカルテスト時に**ステップ実行**ができず、結局 `go test` や `dlv` を使っているメンバーが多くなり「Bazel 辛いよね…」という話になっていました。

# make に移動したわけ

Bazel と比べて触った人が多く、枯れた技術で簡単に使えるということで `make` に移行しました。

- テスト実行 → `make + go test`
- Go バイナリのビルド → `make + go build`
- コンテナイメージの Build と Push → `docker build`
- 自動コード生成 → `make + shell`
- モックの生成 → `make + shell`

Bazel と比較してリモートキャッシュが存在しないため **「テストやビルドの時間がどうなるか？」** が気になりましたが、計測したところ **「同じか、早い」** という結果が出たので問題なく移行できました。

# まとめ

![picture 13](images/ojigi.png)  

Bazel は強力なツールで、クロスプラットフォームでのテストやビルドを実現するには素晴らしいと思っています。その反面利用や運用にはそれなりのコストがかかるため、チーム全員がしっかり Bazel を理解し使えるようになることが必須かなと思います。
